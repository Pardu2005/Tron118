<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRON Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to remove bullets and fix formatting */
        .response-content ul {
            list-style: none !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
        }

        .response-content li {
            list-style: none !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
            position: relative;
        }

        .response-content li::before {
            content: none !important;
        }

        /* Ensure clean heading formatting */
        .clean-heading {
            display: block;
            margin: 8px 0;
            padding: 0;
            font-weight: bold;
            color: #a855f7; /* purple-500 */
        }

        /* Remove any default list styling from prose */
        .prose ul {
            list-style: none !important;
            padding-left: 0 !important;
        }

        .prose li {
            list-style: none !important;
            padding-left: 0 !important;
        }

        .prose li::before {
            content: none !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <header class="bg-gray-800 p-4 flex justify-between items-center">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-blue-500 rounded-full mr-4 flex items-center justify-center">
                <span class="text-xl font-bold">T</span>
            </div>
            <div>
                <h1 class="text-2xl font-bold">TRON Assistant</h1>
                <p class="text-gray-400">AI-Powered Industrial Solution Platform</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <label class="flex items-center">
                <input type="radio" name="input-mode" value="text" class="mr-2" checked> Text
            </label>
            <label class="flex items-center">
                <input type="radio" name="input-mode" value="speech" class="mr-2"> Speech
            </label>
            <label class="flex items-center">
                <input type="radio" name="input-mode" value="hybrid" class="mr-2"> Hybrid
            </label>
            <span id="status-indicator" class="bg-green-500 text-white px-2 py-1 rounded">Online</span>
        </div>
    </header>

    <main class="flex-grow p-6">
        <div class="max-w-4xl mx-auto grid gap-6">
            <div class="p-4 border border-gray-600 rounded">
                <h3 class="text-lg font-semibold mb-2">AI Service Modules</h3>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="mode" value="quiz" class="mr-2">
                        <span class="text-cyan-400">üß† Quiz Generator</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="mode" value="doubt" class="mr-2">
                        <span class="text-purple-400">ü§î Doubt Solver</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="mode" value="code" class="mr-2">
                        <span class="text-red-400">üêõ Code Debugger</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="mode" value="resume" class="mr-2">
                        <span class="text-yellow-400">üìÑ Resume Analyzer</span>
                    </label>
                </div>
            </div>

            <div class="p-4 border border-gray-600 rounded">
                <h3 class="text-lg font-semibold mb-2">Input Interface</h3>
                <textarea id="query-input" class="w-full p-2 border border-gray-500 rounded bg-gray-700 text-white resize-none" rows="4" placeholder="Enter your query here"></textarea>
                <div id="speech-status" class="mt-2 text-sm text-gray-400 hidden"></div>
            </div>

            <div class="p-4 border border-gray-600 rounded">
                <h3 class="text-lg font-semibold mb-2">Action Controls</h3>
                <div class="flex flex-wrap gap-2">
                    <button id="execute-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                        ‚ñ∂Ô∏è Execute
                    </button>
                    <button id="voice-input-btn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                        üé§ Voice Input
                    </button>
                    <button id="stop-listen-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors hidden">
                        ‚èπÔ∏è Stop Listen
                    </button>
                    <button id="read-output-btn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                        üîä Read Output
                    </button>
                    <button id="stop-speech-btn" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors hidden">
                        üîá Stop Speech
                    </button>
                    <button id="upload-file-btn" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition-colors">
                        üìÅ Upload File
                    </button>
                    <button id="clear-btn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors">
                        üóëÔ∏è Clear
                    </button>
                    <button id="clear-history-btn" class="px-4 py-2 bg-red-800 text-white rounded hover:bg-red-900 transition-colors">
                        üóëÔ∏è Clear History
                    </button>
                </div>
            </div>

            <div id="response-output" class="p-4 border border-gray-600 rounded response-content">
                <h3 class="text-lg font-semibold mb-2">AI Response Output</h3>
                <div class="text-gray-300">
                    <div class="bg-gray-800 p-4 rounded border border-blue-500">
                        <p class="text-blue-400 font-semibold">üöÄ Welcome to TRON Assistant</p>
                        <p class="mt-2">Select a service module and enter your query to begin</p>
                        <ul class="mt-3 text-sm text-gray-400">
                            <li>‚Ä¢ <strong class="text-cyan-400">Quiz Generator</strong>: Create practice quizzes on any topic</li>
                            <li>‚Ä¢ <strong class="text-purple-400">Doubt Solver</strong>: Get explanations for complex concepts</li>
                            <li>‚Ä¢ <strong class="text-red-400">Code Debugger</strong>: Debug and optimize your code</li>
                            <li>‚Ä¢ <strong class="text-yellow-400">Resume Analyzer</strong>: Analyze and improve your resume</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div class="p-4 border border-gray-600 rounded">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold">Recent History</h3>
                    <button id="load-history-btn" class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors text-sm">
                        Load History
                    </button>
                </div>
                <div id="history-content" class="text-gray-400 text-sm">
                    Click "Load History" to view recent conversations
                </div>
            </div>

            <!-- Status Display -->
            <div id="status-display" class="p-4 border border-gray-600 rounded">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold">System Status</h3>
                    <button id="check-status-btn" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm">
                        Check Status
                    </button>
                </div>
                <div id="status-content" class="text-gray-400 text-sm">
                    Click "Check Status" to verify system health
                </div>
            </div>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const executeBtn = document.getElementById('execute-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const stopListenBtn = document.getElementById('stop-listen-btn');
        const readOutputBtn = document.getElementById('read-output-btn');
        const stopSpeechBtn = document.getElementById('stop-speech-btn');
        const uploadFileBtn = document.getElementById('upload-file-btn');
        const clearBtn = document.getElementById('clear-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const loadHistoryBtn = document.getElementById('load-history-btn');
        const checkStatusBtn = document.getElementById('check-status-btn');
        const queryInput = document.getElementById('query-input');
        const responseOutput = document.getElementById('response-output');
        const speechStatus = document.getElementById('speech-status');
        const statusIndicator = document.getElementById('status-indicator');
        const historyContent = document.getElementById('history-content');
        const statusContent = document.getElementById('status-content');
        const modeRadios = document.getElementsByName('mode');
        const inputModeRadios = document.getElementsByName('input-mode');

        // Speech Recognition Setup
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isListening = false;

        // Check for speech recognition support
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                speechStatus.textContent = 'üé§ Listening... Speak now';
                speechStatus.classList.remove('hidden');
                voiceInputBtn.classList.add('hidden');
                stopListenBtn.classList.remove('hidden');
                statusIndicator.textContent = 'Listening';
                statusIndicator.className = 'bg-yellow-500 text-white px-2 py-1 rounded';
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    queryInput.value = finalTranscript;
                    speechStatus.textContent = `‚úÖ Recognized: "${finalTranscript}"`;
                } else if (interimTranscript) {
                    speechStatus.textContent = `üé§ Listening: "${interimTranscript}"`;
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                speechStatus.textContent = `‚ùå Error: ${event.error}`;
                resetListeningUI();
            };

            recognition.onend = () => {
                isListening = false;
                if (queryInput.value.trim()) {
                    speechStatus.textContent = '‚úÖ Speech recognized. Click Execute to process.';
                } else {
                    speechStatus.textContent = '‚ùå No speech detected. Try again.';
                }
                resetListeningUI();
            };
        }

        const resetListeningUI = () => {
            voiceInputBtn.classList.remove('hidden');
            stopListenBtn.classList.add('hidden');
            statusIndicator.textContent = 'Online';
            statusIndicator.className = 'bg-green-500 text-white px-2 py-1 rounded';
        };

        const resetSpeechUI = () => {
            stopSpeechBtn.classList.add('hidden');
            readOutputBtn.classList.remove('hidden');
        };

        // Utility Functions
        const getSelectedMode = () => {
            for (const radio of modeRadios) {
                if (radio.checked) return radio.value;
            }
            return null;
        };

        const getSelectedInputMode = () => {
            for (const radio of inputModeRadios) {
                if (radio.checked) return radio.value;
            }
            return 'text';
        };

        const displayResponse = (data) => {
            const h3Element = responseOutput.querySelector('h3');
            if (data.status === 'success') {
                responseOutput.innerHTML = h3Element.outerHTML + (data.response || `<div class="text-green-500">${data.message || 'Operation completed successfully'}</div>`);
            } else {
                responseOutput.innerHTML = h3Element.outerHTML + `<div class="text-red-500">‚ùå Error: ${data.error || 'Unknown error occurred'}</div>`;
            }
        };

        const sendQuery = async (query, mode, inputMode) => {
            try {
                const h3Element = responseOutput.querySelector('h3');
                responseOutput.innerHTML = h3Element.outerHTML + '<div class="text-blue-400">‚è≥ Processing your request...</div>';

                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode, query, inputMode })
                });

                const data = await response.json();
                displayResponse(data);

                // Auto-read response if speech mode is enabled
                const selectedInputMode = getSelectedInputMode();
                if (selectedInputMode === 'speech' || selectedInputMode === 'hybrid') {
                    setTimeout(() => readResponse(), 1000);
                }
            } catch (error) {
                console.error('Error:', error);
                const h3Element = responseOutput.querySelector('h3');
                responseOutput.innerHTML = h3Element.outerHTML + `<div class="text-red-500">‚ùå Network Error: Failed to communicate with server</div>`;
            }
        };

        const readResponse = () => {
            if (!speechSynthesis) {
                alert('Text-to-speech not supported in this browser');
                return;
            }

            // Stop any ongoing speech
            speechSynthesis.cancel();

            // Get clean text from response
            const responseDiv = responseOutput.querySelector('div:not(h3)');
            if (!responseDiv) {
                alert('No response to read');
                return;
            }

            let textToRead = responseDiv.innerText || responseDiv.textContent || '';
            textToRead = textToRead.trim();

            if (!textToRead) {
                alert('No text content to read');
                return;
            }

            // Create utterance
            currentUtterance = new SpeechSynthesisUtterance(textToRead);
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;

            currentUtterance.onstart = () => {
                readOutputBtn.classList.add('hidden');
                stopSpeechBtn.classList.remove('hidden');
                statusIndicator.textContent = 'Speaking';
                statusIndicator.className = 'bg-purple-500 text-white px-2 py-1 rounded';
            };

            currentUtterance.onend = () => {
                resetSpeechUI();
                statusIndicator.textContent = 'Online';
                statusIndicator.className = 'bg-green-500 text-white px-2 py-1 rounded';
            };

            currentUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                resetSpeechUI();
                statusIndicator.textContent = 'Online';
                statusIndicator.className = 'bg-green-500 text-white px-2 py-1 rounded';
            };

            speechSynthesis.speak(currentUtterance);
        };

        const loadHistory = async () => {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();

                if (data.status === 'success' && data.history && data.history.length > 0) {
                    let historyHTML = '<div class="space-y-2 max-h-60 overflow-y-auto">';
                    data.history.forEach((item, index) => {
                        const modeColors = {
                            'Quiz Generator': 'text-cyan-400',
                            'Doubt Solver': 'text-purple-400',
                            'Code Debugger': 'text-red-400',
                            'Resume Analyzer': 'text-yellow-400'
                        };
                        const colorClass = modeColors[item.mode] || 'text-gray-400';

                        historyHTML += `
                            <div class="bg-gray-800 p-2 rounded border border-gray-600 text-xs">
                                <div class="flex justify-between items-center">
                                    <span class="${colorClass} font-semibold">${item.mode}</span>
                                    <span class="text-gray-500">${item.timestamp}</span>
                                </div>
                                <div class="text-gray-300 mt-1">Q: ${item.query}</div>
                                <div class="text-gray-400 mt-1">A: ${item.response}</div>
                            </div>
                        `;
                    });
                    historyHTML += '</div>';
                    historyContent.innerHTML = historyHTML;
                } else {
                    historyContent.innerHTML = '<div class="text-gray-500">No history available</div>';
                }
            } catch (error) {
                console.error('Error loading history:', error);
                historyContent.innerHTML = '<div class="text-red-500">Failed to load history</div>';
            }
        };

        const clearHistory = async () => {
            if (!confirm('Are you sure you want to clear all history? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/history/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    historyContent.innerHTML = '<div class="text-green-500">‚úÖ History cleared successfully</div>';
                    setTimeout(() => {
                        historyContent.innerHTML = 'Click "Load History" to view recent conversations';
                    }, 2000);
                } else {
                    historyContent.innerHTML = `<div class="text-red-500">‚ùå Error: ${data.error || 'Failed to clear history'}</div>`;
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                historyContent.innerHTML = '<div class="text-red-500">‚ùå Network Error: Failed to communicate with server</div>';
            }
        };

        const checkStatus = async () => {
            try {
                statusContent.innerHTML = '<div class="text-blue-400">‚è≥ Checking system status...</div>';

                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.status === 'online') {
                    let statusHTML = `
                        <div class="bg-gray-800 p-3 rounded border border-green-500">
                            <div class="text-green-400 font-semibold mb-2">üü¢ System Online</div>
                            <div class="text-sm text-gray-300">
                                <div>Timestamp: ${new Date(data.timestamp).toLocaleString()}</div>
                                <div class="mt-2">Services Status:</div>
                                <ul class="ml-4 mt-1">
                                    <li>‚Ä¢ Speech Recognition: ${data.services?.speech_recognition || 'Unknown'}</li>
                                    <li>‚Ä¢ Text-to-Speech: ${data.services?.text_to_speech || 'Unknown'}</li>
                                    <li>‚Ä¢ AI Processing: ${data.services?.ai_processing || 'Unknown'}</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    statusContent.innerHTML = statusHTML;
                } else {
                    statusContent.innerHTML = `<div class="text-red-500">üî¥ System Status: ${data.status || 'Unknown'}</div>`;
                }
            } catch (error) {
                console.error('Error checking status:', error);
                statusContent.innerHTML = '<div class="text-red-500">‚ùå Failed to check system status</div>';
            }
        };

        // Event Listeners
        executeBtn.addEventListener('click', () => {
            const query = queryInput.value.trim();
            const mode = getSelectedMode();
            const inputMode = getSelectedInputMode();

            if (!mode) {
                const h3Element = responseOutput.querySelector('h3');
                responseOutput.innerHTML = h3Element.outerHTML + '<div class="text-red-500">‚ùå Please select a service module first.</div>';
                return;
            }

            if (!query && mode !== 'resume') {
                const h3Element = responseOutput.querySelector('h3');
                responseOutput.innerHTML = h3Element.outerHTML + '<div class="text-red-500">‚ùå Please enter a query or upload a file for resume analysis.</div>';
                return;
            }

            sendQuery(query, mode, inputMode);
        });

        voiceInputBtn.addEventListener('click', () => {
            if (!recognition) {
                alert('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
                return;
            }

            if (!isListening) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    speechStatus.textContent = '‚ùå Failed to start speech recognition';
                    speechStatus.classList.remove('hidden');
                }
            }
        });

        stopListenBtn.addEventListener('click', () => {
            if (recognition && isListening) {
                recognition.stop();
            }
        });

        readOutputBtn.addEventListener('click', readResponse);

        stopSpeechBtn.addEventListener('click', () => {
            if (speechSynthesis && currentUtterance) {
                speechSynthesis.cancel();
                resetSpeechUI();
                statusIndicator.textContent = 'Online';
                statusIndicator.className = 'bg-green-500 text-white px-2 py-1 rounded';
            }
        });

        clearBtn.addEventListener('click', () => {
            queryInput.value = '';
            const h3Element = responseOutput.querySelector('h3');
            responseOutput.innerHTML = h3Element.outerHTML + `
                <div class="text-gray-300">
                    <div class="bg-gray-800 p-4 rounded border border-blue-500">
                        <p class="text-blue-400 font-semibold">üöÄ Welcome to TRON Assistant</p>
                        <p class="mt-2">Select a service module and enter your query to begin</p>
                        <ul class="mt-3 text-sm text-gray-400">
                            <li>‚Ä¢ <strong class="text-cyan-400">Quiz Generator</strong>: Create practice quizzes on any topic</li>
                            <li>‚Ä¢ <strong class="text-purple-400">Doubt Solver</strong>: Get explanations for complex concepts</li>
                            <li>‚Ä¢ <strong class="text-red-400">Code Debugger</strong>: Debug and optimize your code</li>
                            <li>‚Ä¢ <strong class="text-yellow-400">Resume Analyzer</strong>: Analyze and improve your resume</li>
                        </ul>
                    </div>
                </div>
            `;
            speechStatus.classList.add('hidden');
        });

        clearHistoryBtn.addEventListener('click', clearHistory);
        loadHistoryBtn.addEventListener('click', loadHistory);
        checkStatusBtn.addEventListener('click', checkStatus);

        uploadFileBtn.addEventListener('click', () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.doc,.docx';
            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    const h3Element = responseOutput.querySelector('h3');
                    responseOutput.innerHTML = h3Element.outerHTML + '<div class="text-red-500">‚ùå No file selected.</div>';
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const h3Element = responseOutput.querySelector('h3');
                    responseOutput.innerHTML = h3Element.outerHTML + '<div class="text-blue-400">üì§ Uploading file...</div>';

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        responseOutput.innerHTML = h3Element.outerHTML + `<div class="text-green-500">‚úÖ ${data.message}</div>`;

                        // Auto-process resume if resume mode is selected
                        const mode = getSelectedMode();
                        if (mode === 'resume') {
                            setTimeout(() => {
                                responseOutput.innerHTML = h3Element.outerHTML + '<div class="text-blue-400">üìÑ Analyzing resume...</div>';
                                sendQuery('', 'resume', 'text');
                            }, 1500);
                        }
                    } else {
                        responseOutput.innerHTML = h3Element.outerHTML + `<div class="text-red-500">‚ùå Error: ${data.error || 'Failed to upload file'}</div>`;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    const h3Element = responseOutput.querySelector('h3');
                    responseOutput.innerHTML = h3Element.outerHTML + '<div class="text-red-500">‚ùå Network Error: Failed to communicate with server during file upload</div>';
                }
            };
            fileInput.click();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                executeBtn.click();
            } else if (e.ctrlKey && e.key === ' ') {
                e.preventDefault();
                voiceInputBtn.click();
            }
        });

        // Auto-resize textarea
        queryInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Initialize - Check system status on load
        setTimeout(() => {
            checkStatus();
        }, 1000);

        console.log('TRON Assistant initialized successfully');
        console.log('Speech Recognition supported:', !!recognition);
        console.log('Speech Synthesis supported:', !!speechSynthesis);
    });
    </script>
</body>
</html>